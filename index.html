<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>Vezi Inscrieri</title>
    <link rel="stylesheet" href="style-inscrieri.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>
<body>

<div class="container">
    <h2>Vezi Tabele din Baza de Date</h2>

    <input id="filterInput" type="text" placeholder="Cauta dupa categorie...">

    <div class="sort-buttons">
        <button class="btn" onclick="sortAsc()">Sortare ↑</button>
        <button class="btn" onclick="sortDesc()">Sortare ↓</button>
        <button class="btn" onclick="exportTableToCSV('tabele.csv')">Export CSV</button>
        <button class="btn" onclick="loadData()">Refresh</button>
    </div>

    <div class="table-responsive">
        <table id="data-table">
            <thead>
                <tr>
                    <th>CATEGORIE</th>
                    <th>SPORTIVI INSCRISI</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
let tableData = [];

// MAPARE DENUMIRI
const nameMap = {
    "plati": "TOTAL SPORTIVI"
};

// AFISARE NUME
function getDisplayName(tableName) {
    return nameMap[tableName] || tableName;
}

// APLICARE REGULA TEAM ×3
function applyTeamRule(row) {
    let count = row.rowCount;
    if (row.tableName.toLowerCase().includes("team")) {
        count = count * 3;
    }
    return count;
}

// LOAD DATA
async function loadData() {
    try {
        const response = await fetch("https://sitedbsportdatamicro.onrender.com/victoria/vezi_inscrieri");

        if (!response.ok) throw new Error("Eroare server");

        tableData = await response.json();
        renderTable(tableData);
    } catch (err) {
        console.error("Eroare incarcare date:", err);
        alert("Eroare la conectare cu serverul!");
    }
}

// RENDER TABEL
function renderTable(data) {
    const tbody = document.querySelector("#data-table tbody");
    tbody.innerHTML = "";

    let totalInscrieri = 0;
    let totalSportivi = null;
    let rest = [];

    data.forEach(row => {
        const displayName = getDisplayName(row.tableName);

        if (displayName === "TOTAL SPORTIVI") {
            totalSportivi = row;
        } else {
            totalInscrieri += applyTeamRule(row);
            rest.push(row);
        }
    });

    // TOTAL SPORTIVI sus
    if (totalSportivi) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>TOTAL SPORTIVI</td><td>${applyTeamRule(totalSportivi)}</td>`;
        tbody.appendChild(tr);
    }

    // TOTAL INSCRIERI sub el
    const totalInscrieriRow = document.createElement("tr");
    totalInscrieriRow.innerHTML = `<td>TOTAL INSCRIERI</td><td>${totalInscrieri}</td>`;
    tbody.appendChild(totalInscrieriRow);

    // restul randurilor normale
    rest.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${getDisplayName(row.tableName)}</td><td>${applyTeamRule(row)}</td>`;
        tbody.appendChild(tr);
    });
}

// FILTRARE
document.getElementById("filterInput").addEventListener("keyup", function () {
    const value = this.value.toLowerCase();

    const filtered = tableData.filter(row =>
        getDisplayName(row.tableName).toLowerCase().includes(value)
    );

    renderTable(filtered);
});

// SORTARE
function sortAsc() {
    renderTable([...tableData].sort((a, b) => applyTeamRule(a) - applyTeamRule(b)));
}

function sortDesc() {
    renderTable([...tableData].sort((a, b) => applyTeamRule(b) - applyTeamRule(a)));
}

// EXPORT CSV
function exportTableToCSV(filename) {
    const csvRows = [["CATEGORIE", "SPORTIVI INSCRISI"]];

    let totalInscrieri = 0;

    tableData.forEach(row => {
        const displayName = getDisplayName(row.tableName);
        const count = applyTeamRule(row);

        csvRows.push([displayName, count]);

        if (displayName !== "TOTAL SPORTIVI") {
            totalInscrieri += count;
        }
    });

    csvRows.push(["TOTAL INSCRIERI", totalInscrieri]);

    const csvString = csvRows.map(row => row.join(",")).join("\n");
    const blob = new Blob([csvString], { type: "text/csv;charset=utf-8;" });

    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
}

// AUTO REFRESH
setInterval(loadData, 30000);

// INIT
loadData();
</script>

</body>
</html>
